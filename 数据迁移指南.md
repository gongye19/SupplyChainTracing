# 数据迁移指南

## 概述

本项目已从旧的 `shipments_raw.csv` 数据源迁移到两批新的 JSON 数据源：
1. **CountryOfOrigin 数据** - 用于主地图视图（显示国家对之间的贸易流向）
2. **country_monthly_industry_data 数据** - 用于 Country Statistics 视图（显示各国的总体贸易统计）

## 迁移步骤

### 1. 清理旧数据和脚本

已自动删除的旧脚本：
- ✅ `backend/scripts/preprocess_tables.py` - 已删除
- ✅ `backend/scripts/import_processed_tables.py` - 已删除

需要手动清理的数据库表：
- `shipments_raw` - 旧的主数据表
- `monthly_company_flows` - 旧的月度公司流数据
- `hs_code_categories` - 旧的 HS 编码分类（如果不再需要）
- `port_locations` - 旧的港口位置（如果不再需要）

### 2. 执行清理和导入

#### 方式一：使用自动化脚本（推荐）

```bash
cd supplychain/backend/scripts
chmod +x clean_and_import_all.sh
./clean_and_import_all.sh
```

#### 方式二：分步执行

**步骤 1：清理旧表**
```bash
cd supplychain/backend/scripts
python3 clean_old_tables.py
```

**步骤 2：导入 CountryOfOrigin 数据（主地图视图）**
```bash
cd supplychain/backend/scripts
python3 import_country_origin.py --clear
```

**步骤 3：导入 country_monthly_industry_data 数据（Country Statistics 视图）**
```bash
cd supplychain/backend/scripts
python3 import_country_trade_stats.py --clear
```

### 3. 配置数据库连接

如果使用本地 Docker Compose 数据库：
```bash
export DATABASE_URL="postgresql://postgres:123456@localhost:5433/supplychain"
```

如果使用 Railway 或其他远程数据库：
```bash
export DATABASE_URL="postgresql://用户名:密码@主机:端口/数据库名"
```

### 4. 验证导入结果

```bash
# 检查数据量
python3 -c "
from sqlalchemy import create_engine, text
import os
DATABASE_URL = os.getenv('DATABASE_URL', 'postgresql://postgres:123456@localhost:5433/supplychain')
engine = create_engine(DATABASE_URL)
with engine.connect() as conn:
    result = conn.execute(text('SELECT COUNT(*) FROM country_origin_trade_stats'))
    print(f'country_origin_trade_stats: {result.scalar():,} 条记录')
    result = conn.execute(text('SELECT COUNT(*) FROM country_monthly_trade_stats'))
    print(f'country_monthly_trade_stats: {result.scalar():,} 条记录')
"
```

## 数据源说明

### CountryOfOrigin 数据
- **位置**: `data/SemiConductor/CountryOfOrigin/`
- **文件格式**: `{hs_code}_{year}_{month}.json`（如 `854231_2021_01.json`）
- **数据结构**: `{原产国代码: {目的地国家代码: [统计数据]}}`
- **用途**: 主地图视图 - 显示国家对之间的贸易流向
- **目标表**: `country_origin_trade_stats`
- **过滤规则**: 自动过滤 `weight=0`、`quantity=0`、`countryCode="N/A"` 的数据

### country_monthly_industry_data 数据
- **位置**: `data/country_monthly_industry_data/SemiConductor/`
- **文件格式**: `{hs_code}_{year}.json`（如 `854231_2021.json`）
- **数据结构**: `{月份: [国家统计数据]}`（只有国家代码，无原产国-目的地国家关系）
- **用途**: Country Statistics 视图 - 显示各国的总体贸易统计
- **目标表**: `country_monthly_trade_stats`

## 注意事项

1. **数据量**: 两批数据都比较大，导入可能需要一些时间（预计 10-30 分钟）
2. **数据库空间**: 确保数据库有足够的存储空间（建议至少 5GB）
3. **备份**: 在生产环境操作前，建议先备份数据库
4. **过滤规则**: CountryOfOrigin 数据导入时会自动过滤无效数据

## 故障排除

### 数据库连接失败
```bash
# 检查数据库是否运行
docker-compose ps db

# 测试数据库连接
docker-compose exec db pg_isready -U postgres
```

### 导入失败
- 检查数据文件是否存在
- 检查数据库连接字符串是否正确
- 查看导入脚本的错误信息

### 数据量异常
- 检查是否有数据被过滤（CountryOfOrigin 数据会过滤无效记录）
- 检查 JSON 文件格式是否正确

## 相关文档

- 详细的数据导入说明：`backend/scripts/README_DATA_IMPORT.md`
- 数据库表结构：`backend/init.sql`

